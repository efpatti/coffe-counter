# ========================================
# WORKFLOW: Coffee Counter Auto-Update
# ========================================
#
# Este workflow automatiza a atualizaÃ§Ã£o do contador de cafÃ©
# Perfeito para aprender GitHub Actions na prÃ¡tica!
#
# O que este workflow faz:
# 1. Roda automaticamente em horÃ¡rios agendados
# 2. Incrementa o contador no arquivo counter.txt
# 3. Atualiza o README.md com o novo valor
# 4. Faz commit e push automÃ¡tico das mudanÃ§as
#
# Aprenda mais em: https://docs.github.com/actions

# Nome do workflow (aparece na aba Actions do GitHub)
name: "â˜• Coffee Counter - Auto Update"

# ========================================
# QUANDO ESTE WORKFLOW DEVE EXECUTAR
# ========================================
on:
  # 1. SCHEDULE - Executa automaticamente em horÃ¡rios programados
  #    Sintaxe: cron usa o formato "minuto hora dia mÃªs dia-da-semana"
  #    Timezone: UTC (sempre)
  schedule:
    # Todo dia 1 de cada mÃªs Ã s 09:00 UTC (06:00 BrasÃ­lia)
    - cron: '0 9 1 * *'

    # Todo dia 10 de cada mÃªs Ã s 09:00 UTC (06:00 BrasÃ­lia)
    - cron: '0 9 10 * *'

    # Todo dia 20 de cada mÃªs Ã s 09:00 UTC (06:00 BrasÃ­lia)
    - cron: '0 9 20 * *'

  # 2. WORKFLOW_DISPATCH - Permite executar manualmente
  #    Ãštil para: Testar o workflow sem esperar o schedule
  #    Como usar: VÃ¡ em Actions > Coffee Counter > Run workflow
  workflow_dispatch:

  # 3. PUSH - (Opcional) Executa quando fizer push na main
  #    Descomente as linhas abaixo se quiser que rode a cada push:
  # push:
  #   branches:
  #     - main

# ========================================
# PERMISSÃ•ES NECESSÃRIAS
# ========================================
# Define o que o workflow pode fazer no repositÃ³rio
permissions:
  contents: write  # Permite fazer commits e push

# ========================================
# JOBS (TRABALHOS)
# ========================================
# Um workflow pode ter vÃ¡rios jobs que rodam em paralelo ou sequencialmente
jobs:

  # Job: update-counter
  # Este Ã© o Ãºnico job deste workflow
  update-counter:

    # Tipo de mÃ¡quina virtual onde o job vai rodar
    # ubuntu-latest: Ubuntu Linux mais recente (gratuito para repos pÃºblicos)
    runs-on: ubuntu-latest

    # ========================================
    # STEPS (PASSOS)
    # ========================================
    # Cada job Ã© composto de vÃ¡rios steps que executam sequencialmente
    steps:

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # STEP 1: Checkout do cÃ³digo
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Baixa o cÃ³digo do repositÃ³rio para a mÃ¡quina virtual
      # Sem isso, a VM estaria vazia!
      - name: "ðŸ“¥ Checkout do repositÃ³rio"
        uses: actions/checkout@v4
        with:
          # Importante: busca o histÃ³rico completo para poder fazer commit
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # STEP 2: Incrementar o contador
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Executa um script bash que:
      # - LÃª o valor atual de counter.txt
      # - Incrementa em 1
      # - Salva o novo valor
      # - Atualiza o README.md
      - name: "â˜• Incrementar contador de cafÃ©"
        run: |
          # Define o arquivo do contador
          FILE=counter.txt

          # Se o arquivo nÃ£o existir, cria com valor 0
          if [ ! -f $FILE ]; then
            echo "ðŸ“ Criando $FILE pela primeira vez..."
            echo 0 > $FILE
          fi

          # LÃª o valor atual
          COUNT=$(cat $FILE)
          echo "ðŸ“Š Contador atual: $COUNT"

          # Incrementa o contador
          COUNT=$((COUNT + 1))
          echo "âœ¨ Novo contador: $COUNT"

          # Salva o novo valor
          echo $COUNT > $FILE

          # Atualiza o README.md com o novo valor
          echo "ðŸ“ Atualizando README.md..."
          cat > README.md << EOF
          # â˜• Coffee Counter

          ![Coffee](https://img.shields.io/badge/Caf%C3%A9s%20Consumidos-$COUNT-brown?style=for-the-badge&logo=buy-me-a-coffee)
          ![GitHub Actions](https://img.shields.io/badge/GitHub-Actions-blue?style=for-the-badge&logo=github-actions)
          ![Auto Update](https://img.shields.io/badge/Auto-Update-success?style=for-the-badge&logo=clockify)

          ## ðŸ“Š Contador Atual

          **Total de cafÃ©s consumidos:** \`$COUNT\` â˜•

          > *Mais cafÃ© = mais energia!* âš¡

          ---

          ## ðŸŽ¯ Sobre este projeto

          Este Ã© um projeto didÃ¡tico para aprender **GitHub Actions** na prÃ¡tica!

          ### Como funciona?

          1. ðŸ“… O GitHub Actions roda automaticamente nos dias 1, 10 e 20 de cada mÃªs
          2. ðŸ¤– Um script incrementa automaticamente o contador
          3. ðŸ“ O arquivo \`counter.txt\` e este README sÃ£o atualizados
          4. ðŸ’¾ Um commit automÃ¡tico Ã© feito
          5. ðŸš€ As mudanÃ§as sÃ£o enviadas para o repositÃ³rio

          ### Estrutura do projeto

          \`\`\`
          coffee-counter/
          â”œâ”€â”€ index.html              # PÃ¡gina web do contador
          â”œâ”€â”€ script.js               # LÃ³gica do contador
          â”œâ”€â”€ counter.txt             # Armazena o nÃºmero atual
          â”œâ”€â”€ README.md               # Este arquivo
          â””â”€â”€ .github/
              â””â”€â”€ workflows/
                  â””â”€â”€ update-coffee.yml   # Workflow do GitHub Actions
          \`\`\`

          ### Como testar localmente

          \`\`\`bash
          # Clone o repositÃ³rio
          git clone [seu-repositorio]

          # Entre na pasta
          cd coffee-counter

          # Inicie um servidor local
          python3 -m http.server 8000
          # ou use a extensÃ£o Live Server do VS Code

          # Abra no navegador
          # http://localhost:8000
          \`\`\`

          ### Como configurar no seu GitHub

          1. ðŸ“ Crie um repositÃ³rio novo
          2. ðŸ“¤ FaÃ§a push deste cÃ³digo
          3. âš™ï¸ VÃ¡ em Settings > Pages
          4. ðŸŒ Ative GitHub Pages apontando para branch main, pasta raiz
          5. ðŸŽ‰ Pronto! Seu Coffee Counter estÃ¡ no ar!

          ### Testando o workflow manualmente

          1. VÃ¡ na aba **Actions** do seu repositÃ³rio
          2. Clique no workflow "Coffee Counter - Auto Update"
          3. Clique em **Run workflow**
          4. Aguarde alguns segundos
          5. Veja o commit automÃ¡tico aparecer!

          ---

          ## ðŸ“š Aprenda mais

          - [GitHub Actions Documentation](https://docs.github.com/actions)
          - [GitHub Pages](https://pages.github.com/)
          - [Cron Schedule Examples](https://crontab.guru/)

          ---

          *Ãšltima atualizaÃ§Ã£o automÃ¡tica: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*

          **Feito com â˜• e ðŸ’»**
          EOF

          echo "âœ… README.md atualizado!"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # STEP 3: Configurar Git
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Configura o nome e email para os commits do bot
      - name: "ðŸ”§ Configurar Git"
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # STEP 4: Commit e Push
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Faz commit das mudanÃ§as e envia para o repositÃ³rio
      - name: "ðŸ’¾ Commit e Push das alteraÃ§Ãµes"
        run: |
          # Captura o novo valor do contador para usar na mensagem de commit
          NEW_COUNT=$(cat counter.txt)

          # Adiciona os arquivos modificados
          git add counter.txt README.md

          # Verifica se hÃ¡ mudanÃ§as para commitar
          # (Evita erro se o workflow rodar mas nada mudou)
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Nenhuma mudanÃ§a para commitar"
          else
            # Faz o commit
            git commit -m "â˜• Auto-update: $NEW_COUNT cafÃ©s consumidos

          ðŸ¤– AtualizaÃ§Ã£o automÃ¡tica via GitHub Actions
          ðŸ“… $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

            # Faz push para o repositÃ³rio
            git push

            echo "âœ… Commit realizado e push feito com sucesso!"
          fi

# ========================================
# DICAS PARA PERSONALIZAR
# ========================================
#
# ðŸ• Mudar horÃ¡rios do schedule:
#    Use https://crontab.guru/ para gerar a expressÃ£o cron
#    Exemplo: '0 12 * * 1' = Toda segunda-feira ao meio-dia UTC
#
# ðŸ“Š Adicionar mais steps:
#    VocÃª pode adicionar steps para enviar notificaÃ§Ãµes,
#    fazer deploy, rodar testes, etc.
#
# ðŸ” Usar secrets:
#    Para APIs e tokens: ${{ secrets.SEU_SECRET }}
#    Configure em: Settings > Secrets and variables > Actions
#
# ðŸ“¦ Usar outras actions:
#    Visite: https://github.com/marketplace?type=actions
#
# ========================================
